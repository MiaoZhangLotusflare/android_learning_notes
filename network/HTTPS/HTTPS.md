# HTTPS

　　https 协议（Hypertext Transfer Protocol Secure）：超文本传输安全协议。缩写为：HTTPS，常称为 HTTP over TLS，HTTP over SSL 或 HTTP source，是一种网络安全传输协议。

　　HTTP 协议传输的数据都是未加密的，也就是明文，因此试用 HTTP 协议传输隐私信息非常不安全。HTTP 使用 80 端口通讯，而 HTTPS 占用 443 端口通讯。在计算机网络上，HTTPS 经由超文本传输协议（HTTP）进行通信，但利用 SSL/TLS 来加密数据包。HTTPS 开发的主要目的，是提供对网络服务器的身份验证，保护交换数据的隐私与完整性。这个协议由网景公司（Netscapt）在 1994 年首次题出，随后扩展到互联网上。

　　是一种通过计算机网络进行安全通信的传输协议。HTTPS 经由 HTTP 进行通信，但利用 SSL/TSL 来加密数据包。HTTPS 开发的主要目的是提供对网站服务器的身份认证，保护交换数据的隐私与完整性。这个协议由网景公司（Netscape）在 1994 年首次提出，随后扩展到互联网上。

　　简单来说，HTTPS 是 HTTP 的安全版，是使用 SSL/TLS 加密的 HTTP 协议。通过 TSL/SSL 协议的身份验证、信息加密和完整性校验的功能，从而避免信息窃听、信息篡改和信息劫持的风险。

　　HTTPS 提供了加密（Encryption）、认证（Verification）、鉴定（Identification）三种功能。

1. 私密性（Confidentiality/Privacy）：也就是提供信息加密，保证数据传输的安全。
2. 可信性（Authentication）：身份验证，主要是服务器端的，确认网站的真实性，有些银行也会对客户端进行认证。
3. 完整性（Message Integrity）：保证信息传输过程中的完整性，防止被修改。

　　HTTPS 就是在应用层和传输层中间加了一道验证的门槛以保证数据安全。

![](image/https.jpg)

## SSL/TLS 协议

　　SSL（Secure Socket Layer）安全套接层

　　TLS（Transport Layer Security）传输层安全

　　1996 年 NetScape 公司发布 SSL V3.0；1999 年互联网标准化组织 ISOC 接替 NetScape 公司，发布了 SSL 的升级版 TLS 1.0 版；2006 年和 2008 年，TLS 进行了两次升级，分别为 TLS 1.1 版和 TLS 1.2 版。

　　SSL 及其继任者 TLS 是为网络通信提供安全及数据完整性的一种安全协议。TLS 与 SSL 在传输层对网络连接进行加密。

　　SSL 协议主要服务：

1. 认值用户和服务器，确保数据发送到正确的客户机和服务器。
2. 加密数据以防止数据中途被窃取。
3. 维护数据的完整性，确保数据在传输过程中不被改变。

## 基本的运行过程

　　SSL/TLS 协议的基本思路是采用公钥加密法，也就是说，客户端先向服务器索要公钥，然后用公钥加密信息，服务器收到密文件后，用自己的私钥解密。

1. 如何保证公钥不被篡改？

   解决方法：将公钥放在数字证书中。只要证书是可信的，公钥就是可信的。

2. 公钥加密计算量太大，如何减少耗用的时间？

   解决方法：每一次对话（seesion），客户端和服务器端都生成一个 “对话密钥”（session key），用它来加密信息。由于 “ 对话密钥 ” 是对称加密，所以运算速度非常快，而服务器公钥只用于加密 “ 对话密钥 ” 本身，这样就减少了加密运算的消耗时间。

### SSL/TSL 协议的基本过程

　　SSL/TLS 协议的基本过程是这样的：

1. 客户端向服务器端索要并验证公钥。
2. 双方协商生成 “ 对话密钥 ”。
3. 双方采用 “ 对话密钥 ” 进行加密通信。

　　前两步，又称为 “ 握手阶段 ”（handshake）。

### SSL、TLS 的握手过程

![](image/SSL与TLS的握手过程.png)

　　SSL 协议在握手阶段使用的是非对称加密，在传输节点使用的是对称加密，也就是说在 SSL 上传送的数据是使用对称密钥加密的。

　　因为非对称加密的速度缓慢，浪费资源。其实当客户端和主机使用非对称加密方式建立连接后，客户端和主机已经决定好了在传输过程使用的对称加密算法和关键的对称加密密钥，由于这个过程本身是安全可靠的，也即对成加密密钥是不可能被窃取盗用的，因此，保证了在传输过程中对数据进行对称加密也是安全可靠的，因为出了客户端和之际之外，不可能有第三方窃听并解密出对称加密密钥。如果有人窃听通信，它可以直到双方选择的加密方法，以及三个随机数中的两个。整个通话的安全，只取决于第三个随机数（pre-master secret）能不能被破解。

　　第三个随机数 c，又称 “ pre-master key ”。有了它以后，客户端和服务器就同时有了三个随机数，接着双方就用实现商定的加密方法，各自生成本次会话所用的同一把 " session key（会话密钥）"。

　　为什么一定要用三个随机数，来生成 “ 会话密钥 ”，SSL 协议不信任每个主机都能产生完全随机的随机数，如果随机数不随机，那么会话密钥就有可能被猜出来，一个伪随机可能完全不随机，可是三个伪随机就十分接近随机了，每增加一个自由度，随机性增加的可不是一。

　　客户端收到服务器第一次的回应以后，首先验证服务器证书。如果证书不是可信机构颁布、或者证书中的域名与实际域名不一致、或者证书已经过期，就会向访问者显示一个警告，由其选择是否还要继续通信。

　　服务器收到客户端的三个随机数之后，计算生成本次会话所用的 “ 会话密钥 ”。然后，向客户端最后发送下面信息：

1. 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
2. 服务器握手结束通知，表示服务器的握手阶段已经结束，这一项同时也是前面发送的所有内容的 hash 值，用于供客户端校验。

　　至此，整个握手阶段全部结束。接下来，客户端与服务器进入加密通信，就完全是使用普通的 HTTP 协议，只不过用 “ 会话密钥 ” 加密内容。

　　HTTPS 在传输数据之前需要客户端（浏览器）与服务端（网站）之前进行一次握手，在握手过程中将确立双方加密传输数据的密码信息。TLS/SSL 中使用了非对称加密、对称加密以及 HASH 算法。

　　握手过程的具体描述如下：

1. 浏览器将自己支持的一套加密规则发送给网站。
2. 网站从中选出一组加密算法与 HASH 算法，并将自己的身份信息以证书的形式发回给浏览器。证书里面包含了网站地址、加密公钥以及证书的颁发机构等信息。
3. 浏览器获得网站证书之后浏览器要做一下工作：
   * a. 验证证书的合法性（办法证书的机构是否合法，证书中包含的网站地址是否与正在访问的地址一致等），如果证书受信任，则浏览器栏里面会显示一个小锁头，否则会给出证书不受信的提示。
   * b. 如果证书受信任，或者是用户接受了不受信的证书，浏览器会生成一串随机数的密码，并用证书中提供的公钥加密。
   * c. 使用约定好的 HASH 算法计算握手消息，并使用生成的随机数对消息进行加密，最后将之前生成的所有信息发送给网站。
4. 网站接收浏览器发来的数据之后要做以下操作：
   * a. 使用自己的私钥将信息解密取出密码，使用密码解密浏览器发来的握手信息，并验证 HASH 是否与浏览器发来的一致。
   * b. 使用密码加密一段握手消息，发送给浏览器。
5. 浏览器解密并计算握手消息的 HASH，如果与服务段发来的 HASH 一直，此时握手过程结束，之后所有的通信数据将由之前浏览器生成的随机密码并利用对称加密算法进行加密。

　　这里浏览器与网站互相发送加密的握手消息并验证，目的是为了保证双方都获得了一致的密码，并且可以正常地加密解密数据，为后续真正数据地传输做一次测试。另外，HTTPS 一般使用的加密与 HASH 算法如下：

* 非对称加密算法：RSA、DSA/DSS
* 对称加密算法：AES、RC4、3DES
* HASH 算法：MD5、SHA1、SHA256

　　HTTPS 对应的通信时序图如下：

![](image/https对应的通信时序图.png)





## 对客户端的验证

　　对于非常重要的保密数据，服务端还需要对客户端进行验证，以保证数据传送给了安全的合法的客户端。服务端可以向客户端发出 Cerficate Request 消息，要求客户端发送证书给客户端的合法性进行验证。比如，金融机构往往只允许认证客户连入自己的网络，就会向正式客户提供 USB 密钥，里面就包含了一张客户端证书。

## Session 的恢复

　　有两个方法可以恢复原来的 session：一种叫做 session ID，另一种叫做 session ticket。

### session ID

　　session ID 的思想很简单，就是每一次对话都有一个编号（session ID）。如果对话中断，下次重连的时候，只要客户端给出这个编号，且服务器有这个编号的记录，双方就可以重新使用已有的 “ 对话密钥 ”，而不必重新生成一把。

　　session ID 是目前所有浏览器都支持的方法，但是它的缺点在于 session ID 往往只保留在一台服务器上。所以，如果客户端的请求发到另一台服务器，就无法恢复对话。

### session ticket

　　客户端发送一个服务器在上一次对话中发送过来的 session ticket。这个 session ticket 是加密的，只有服务器才能解密，其中包括本次对话的主要信息，比如对话密钥和加密方式。当服务器收到 session ticket 以后，解密后就不必重新生成对话密钥了。目前只有 Firefox 和 Chrome 浏览器支持。

## HTTPS 协议和 HTTP 协议的区别

1. https 协议需要到 ca 申请证书，一般免费证书很少，需要缴费。
2. http 是超文本传输协议，信息是明文传输，https 则是具有安全性的 ssl 加密传输协议。
3. http 和 https 使用的是完全不同的连接方式用的端口也不一样，前者是 80，后者是 443。
4. http 的连接很简单，是无状态的。
5. HTTPS 协议是由 SSL + HTTP 协议构建的可进行加密传输、身份认证的网络协议，要比 http 协议安全。

## SSL 证书

　　HTTPS 核心的一个部分是数据传输之前的握手，握手过程中确定了数据加密的密码。在握手过程中，网站会向浏览器发送 SSL 证书，SSL 证书是一个支持 HTTPS 网站的身份证明，SSL 证书里面包含了网站的域名、证书有效期、证书的颁发机构以及用于加密传输密码的公钥等信息，由于公钥加密的密码之恶能被在申请证书时生成的私钥解密，因此浏览器在生成密码之前需要先核对当前当纹的域名与证书上绑定的域名是否一直，同时还要对证书的办法机构进行验证，如果验证失败浏览器会给出证书错误的提示。

## 证书的类型

　　实际上，使用的证书分很多种类型，SSL 证书只是其中的一种。证书的格式是由 X.509 标准定义。SSL 证书负责传输公钥，是一种 PKI（Public Key Infrastructure，公钥基础结构）证书。

　　常见的证书根据用途不同大致有以下几种：

1. SSL 证书，用于加密 HTTP 协议，也就是 HTTPS。
2. 代码签名证书，用于签名二进制文件，比如 Windows 内核驱动、Firefox 插件、Java 代码签名等等。
3. 客户端证书，用于加密邮件。
4. 双因素证书，网银专业版使用的 USB Key 里面用的就是这种类型的证书。

　　这些证书都是由受认证的证书颁发机构 -- CA（Certificate Authority）机构来颁发，针对企业与个人的不同，可申请的证书的类型也不同，价格也不同。CA 机构颁发的证书都是受信任的证书，对于 SSL 证书来说，如果访问的网站与证书绑定的网站一致就可以通过浏览器的验证而不会提示错误。

## SSL 证书申请与规则

　　SSL 证书可以向 CA 机构通过付费的方式申请，也可以自己制作。CA 机构颁发的证书价格非常昂贵，而且有效期i一般只有一年到三年不等（年数不同，价格也不同），过期之后还要再次交钱申请，因此一般只有企业才能申请证书。但是随着个人网站的增多，目前也有针对个人的 SSL 证书服务，价格相对便宜一些，国内的话 400 多块钱就能申请到一个，国外更是有免费的 SSL 证书可以申请。

　　在申请 SSL 证书时需要向 CA 机构提供网站域名、营业执照以及申请人的身份信息等。网站的域名非常重要，申请人必须证明自己对域名有所有权，如果支持 Hotmail.com、Gmail.com 的 SSL 证书都可以随便申请，黑客们就不用做假证书欺骗了。

　　此外，一个证书一般只绑定一个域名，如果 CA 机构心情好的话，会免费再绑一个，比如要申请域名时绑定的域名是 www.runoob.com，那么只有再浏览器地址是 https://www.runoob,com 的时候，这个证书才是受信任的，如果地址是 https://rr.runoob,com 或者 https://login.runoob.com ，那么这个证书由于访问的域名与证书绑定的域名不同，仍然会被浏览器显示为不受信任的。

　　CA 机构也提供申请通配符域名（例如，*.runoob.com），通配符域名相当于绑定了主域名下的所有域名，因此使用起来非常方便，但是价格也超级昂贵，一个通配符域名一年大概得 5000 块钱，只有企业才可以申请。

　　EV SSL 证书（扩展验证 SSL 证书），EV SSL 证书有个特点是可以让浏览器的地址变绿，同时显示出来证书所属公司的名称，而 EV SSL 证书与其他证书相比，费用更高。

　　以上说的是向 CA 机构申请证书的情况，如果个人网站只为加密传输也可以自己制作 SSL 证书，自己制作的证书不会受到浏览器的信任，再访问的时候由于证书验证失败而给出警告。

## 证书的验证过程

　　证书以证书链的形式组织，在颁布证书的时候首先要有根 CA 机构颁布的根证书，再由根 CA 结构颁发一个中级 CA 机构的证书，最后由中级 CA 机构颁发具体的 SSL 证书。可以这样理解，根 CA 机构就是一个公司，根证书就是他的身份凭证，每个公司由不同的部门来颁发不同用途的证书，这些不同的部门就是中级 CA 机构，这些中级 CA 机构使用中级证书作为自己的身份凭证，其中有一个部门是专门颁发 SSL 证书，当把根证书、中级证书以及最后申请的 SSL 证书连在一起就形成了证书链，也称为证书路径。在验证证书的时候，浏览器回调用系统的证书管理器接口对证书路径中的所有证书一级一级的进行验证，只有路径中所有的证书都是受信的，整个验证的结果才是受信。

　　根证书是最关键的一个证书，如果根证书不受信任，它下面颁发的所有证书都不受信任。操作系统在安装过程中会默认安装一些受信任的 CA 机构的根证书，可以在 “运行” 里面运行 “certmgr.msc” 启动证书管理器。

　　根证书的有效期长，支持的用途多以方便颁发不同用途类型的中级证书；中级证书用途单一，有效期相对短一些，但是比具体的 SSL 证书要长很多。

　　如果 SSL 证书验证失败根据浏览器的不同会有以下的错误提示：

```
There is a problem with this website's security certificate.
或者
The site's security certificate is not trusted!
```

　　SSL 证书验证失败有以下三点原因：

1. SSL 证书不是由受信任的 CA 机构颁发的。
2. 证书过期。
3. 访问的网站域名与证书绑定的域名不一致。

　　这三点原因也是 IE 浏览器给出的提示。



## SSL 证书的安全问题

　　对 HTTPS 最常见的攻击手段就是 SSL 证书七篇或者叫 SSL 劫持，是一种典型的中间人攻击。不过 SSL 劫持并非只是用于攻击目的，在一些特殊情况下利用 SSL 劫持我们可以更流畅的访问网络。

　　以攻击为目的的 SSL 劫持如果不注意浏览器安全提示的话，很容易就中招。当网络中有中间人发起 SSL 劫持攻击时，攻击者需要伪造一个 SSL 证书发给浏览器，这个时候由于伪造的 SSL 证书不受信任，浏览器会给出提示。

　　这里有一个误区，当 SSL 证书不受信任的时候，并不一定就是有 SSL 挟持发生，有种例外情况是：一些个人网站买不起合法的 SSL 证书，因此会自己制作一个 SSL 证书来加密传输的数据。如果经常访问某个个人网站，而且知道这个网站是干什么的，那么这种情况可以不用担心。但是如果访问的是网银、在线支付或者是 hotmail.com、gmail.com 等，这类公司行置的网站一定会申请合法的 SSL 证书（12306.cn 除外），一旦 SSL 证书不收信任，应该果断地终止访问，这个时候网络中一定会存在异常行为，对于一些小区宽带地用户一定要注意这点。

　　最后总结以下使用 SSL 证书要注意的问题：

1. 除非必要，不要随意安装根证书。安装根证书的时候一定要明确证书的来源。
2. 对于网银、在线支付、重要邮箱等网站，一定要确保 SSL 证书是没有问题的，如果浏览器给出 SSL 证书错误的警告，一定要拒绝访问。一些小区宽带用户一定要注意这点。
3. 由于现在个人申请 SSL 证书比较便宜，一定要注意悬挂着合法 SSL 证书的钓鱼网站（国外比较常见）。对于钓鱼网站，一定要看清域名，另外别相信什么中奖的消息，同时要安装带有钓鱼防护功能的安全软件。

## 参考文章

1. [https协议](https://www.jianshu.com/p/f9b8a3e62af1)
2. [HTTPS 与 SSL 证书概要](https://www.runoob.com/w3cnote/https-ssl-intro.html)