# 第 11 章 应用发布与热更新

## 11.1. iOS 应用发布

​		打包完成之后，iOS 应用只需要发布到 App Store 即可。由于 Android 生态的应用商店比较多，所以还需要针对不同的应用商店打渠道包，然后才能发布到应用商店。

### 11.1.1. 加入开发者计划

​		关于如何发布 iOS 应用到 App Store，苹果官方文档已经有了很详细的说明。和普通的 iOS 应用发布流程一样，React Native 应用也需要通过原生平台打包后才能发布到 App Store，涉及的步骤主要有以下几个。

* 加入开发者计划。
* 生成证书文件（如发布证书、注册 App ID、生成描述文件）。
* 打包 iOS 应用。
* 将应用到发布 App Store。

### 11.1.2. 生成发布证书

​		要将 iOS 应用发布到 App Store，还需要开发者具有发布证书、App ID 和描述文件，

​		在 iOS 开发中，iOS 的证书分为开发证书和发布证书两种。其中，开发证书主要用于测试环境，发布证书则主要用于将应用提交给 App Store 审核时使用。

### 11.1.3. 注册 App ID

​		App ID 是苹果开发者计划的一部分，主要用来标识一个或一组 iOS 应用，是应用的唯一标识。

​		注册 App ID 时需要填写两个重要的内容：Description 和 Suffix。其中，Description 是应用的描述信息，Suffix 是应用的唯一标识，需要与 Bundle Identifier 保持一致。

### 11.1.4. 生成描述文件

​		描述文件是 iOS 系统特有的设置文件，包含了设备的授权信息，如网络配置、访问限制和安全策略等。

### 11.1.5. 打包资源文件

​		和原生 iOS 应用的打包发布过程略有不同，在发布 React Native 项目的 iOS 正式应用包之前，还需要对 JavaScript 资源进行打包

### 11.1.6. 发布 iOS 应用

​		接着就是生成证书的应用包。

​		最后，只需要将应用发布到 iTunes Connect。iTunes Connect 是苹果公司提供的一套基于 Web 的管理系统，便于开发者提交和管理 App。提交成功后，等待苹果官方的审核结果即可。

## 11.2. Android 应用发布

​		Android 应用安装包主要分为 Debug 和 Release 两种。其中，Debug 包用于开发调试，Release 包用于正式发布。正式包需要使用签名文件打包后才能对外发布。

​		之所以要使用签名文件来制作正式包，是因为 Android 系统要求所有应用都使用签名文件加密后才能安装在用户手机上，这也是出于应用和用户信息的安全考虑。因此，在将 Android 应用发布到应用商店之前，需要对生成的 APK 包进行签名。

​		按照制作签名文件的要求填入相关的信息即可。需要提醒的是，签名密码和昵称是非常重要的信息，需要妥善保管，一旦丢失或泄露，对于之后的版本发布会造成一些麻烦。

### 11.2.2. 打包资源文件

​		和 Android 原生应用打包发布过程略有不同，制作 Android 正式应用包之前还需要对 JavaScript 资源执行打包操作。

### 11.2.3. 发布 Android 应用

​		准备好签名文件和 JavaScript 资源包之后，就可以开始制作 Android 正式应用包了。

​		关于 Android 渠道包的制作，Android 官方提供了 Gradle 渠道配置方案。具体来说，只需要在 Android 工程的 app/build.gradle 文件的 productFlavors 节点添加具体渠道配置即可，如下所示。

```groovy
    productFlavors {
        samplechannel{
            dimension 'default'
        }
        yingyongbao{
            dimension 'default'
        }
    }
```

​		除了使用官方的 Gradle 多渠道打包方案之外，还可以使用友盟、美团发布的一键多渠道打包工具。

​		完成打包操作之后，只需要将生成的正式包发布到应用商店即可。除了谷歌官方的 Google Play，国内比较著名的 Android 应用商店还有腾讯应用宝、华为应用市场、百度手机助手和小米商店等。只需要将正式应用包发布到这些应用商店，即可供用户下载。

## 11.3. 热更新详解

### 11.3.1. 热更新基础知识

​		原生应用开发完成后需要经过打包发布到应用商店，然后通过应用商店的审核后才能被用户下载。然而，Android 应用商店的审核时间大概需要 1 至 2 天，而 iOS 应用商店的审核则需要 3 至 5 天。但是移动应用产品的迭代更新速度非常快，通常 1 至 2 周或者几天时间就需要完成一次版本迭代。

​		热更新技术就是为了解决这一问题而生的。不用提交应用商店进行审核，即可完成代码的更新。在原生 Android 开发中，可以使用 Tinker、AndFix 和 Qzone 等热更新框架来完成代码的更新。而对于原生 iOS 开发来说，则可以使用 Aspects 等热修复框架来完成代码的热更新。

​		与原生应用采用的热更新技术不同，React Native 天生就具备热更新特性，可以很方便地通过服务器动态更新 JavaScript 代码来实现应用的热更新。

![React Native框架热更新的工作原理图](https://res.weread.qq.com/wrepub/epub_31403502_140)

​		可以发现，React Native 应用的热更新是由客户端发起的，通过和服务器端的交互来判断是否需要执行热更新操作，工作流程如下图所示。

![热更新工作流程示意图](https://res.weread.qq.com/wrepub/epub_31403502_141)

​		由此可见，要完成 React Native 应用的热更新操作，需要经历以下几个步骤。

* 部署热更新服务，添加客户端版本配置。
* 客户端执行热更新检测，判断是否需要更新。
* 如果需要更新，则可以从服务器端下载资源文件差分包，然后在本地执行资源的合并操作并执行合并文件的加载操作；如果不需要更新，则直接加载内置的资源文件即可。

​		目前，React Native 提供的热更新方案中，比较成熟的有 React Native 中文社区推出的 Pushy 和微软推出的 CodePush，具体使用哪一种热更新方案，要根据实际情况来选择。

### 11.3.2. 应用启动过程

​		React Native 的加载经历的流程如下。

* 由 React Native 将 JavaScript 的资源打包。
* 执行 run 命令时系统会默认启动一个基于 Node.js 的 React Native 服务，并且此服务运行在本地，监听的默认端口号是 8081。
* 当应用请求本地的 index.ios.bundle 资源时，就会从 React Native 服务实时获取最新的 JavaScript 资源。
* 当 JavaScript 资源发生变化时，React Native 会重新执行打包操作，并通知原生应用重新加载。

​		这种设计机制，让 React Native 天生就具备了热更新特性，并且不需要引入额外的技术支持。

### 11.3.3. 热更新示例

​		正常情况下，要实现代码的热更新，就需要通过服务器端进行代码下发，即将需要修复的代码放到服务器中，然后客户端每次启动的时候都会通过接口来判断是否需要执行更新，如果需要更新，则从服务器拉取最新代码。

## 11.4. CodePush 实战

​		作为一个移动跨平台应用开发框架，React Native 虽然提供了动态更新的基础，但是动态更新方案并不完善。因为一个完整的热更新方案，除了客户端的支持外，还需要服务器端的支持。好在微软开发的 CodePush 技术框架，填补了 React Native 应用在动态更新方面的空白，开发者也可以使用它完成代码的热修复。

​		CodePush 是微软开发的一套云服务器技术，可以用于实现 Cordova 和 React Native 应用的热更新。借助 CodePush 云服务器，开发者可以直接部署移动应用更新，并快速实现代码的热更新。CodePush 作为一个中央仓库，开发者可以实时推送更新，然后客户端可以在应用启动时查询更新。这样一来，不需要重新打包发布、审核和安装应用，就可以轻松解决应用的缺陷或添加新特性。CodePush 支持的功能如下。

* 直接对用户部署代码更新。
* 管理 Alpha、Beta 和生产环境应用。
* 支持 React Native 和 Cordova 跨平台技术的热更新。
* 支持 JavaScript 文件与图片资源的更新。

### 11.4.2. CodePush 安装与账号注册

​		向 CodePush 云服务器注册应用时需要指明应用对应的平台。成功地向 CodePush 注册应用后，每个应用都会生成两个 Deployment Key，即 Production 和 Staging。其中， Production 用于生产环境，Staging 则用于模拟环境。

### 11.4.3. 集成 CodePush SDK

​		使用 react-native link 命令链接原生库时，如果直接跳过输入 Deployment Key，也可以在原生端手动配置。

### 11.4.4. 手动集成 CodePush SDK

​		CodePush 热更新所需要的原生配置完成。

### 11.4.5. iOS 应用热更新

​		使用 CodePush 的 code-push release 命令行工具发布针对 iOS 的更新。

### 11.4.6. Android 应用热更新

​		Android 应用的热更新也需要原生配置的支持。使用 react-native link 命令链接原生库依赖，热更新所需要的原生环境就已经配置完成，接下来只需要修改 React Native 对应的更新逻辑即可。

​		使用 CodePush 的 code-push release 命令行工具发布针对 Android 平台的热更新。

## 11.5. 本章小结

​		当 React Native 项目开发完成之后，就需要对应用进行打包。打包 React Native 项目需要原生平台的支持，当应用包制作完成之后，还需要发布到应用商店才能被用户下载。

​		作为一个移动跨平台框架，React Native 提高了移动应用的开发效率，不仅如此，React Native 还支持热更新。正是因为具备这些特性，才让 React Native 在短期内成为跨平台开发的主流技术。

