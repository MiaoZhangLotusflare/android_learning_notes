# 第 4 章 构筑测试体系

​		如果你想进行重构，首要前提就是拥有一个可靠的测试环境。就算你够幸运，有一个可以自动进行重构的工具，你还是需要测试。而且短时间内不可能有任何工具可以为我们自动进行所有可能的重构。

​		我并不把这视为缺点。我发现，编写优良的测试程序，可以极大提高我的编程速度，即使不进行重构也一样如此。

## 4.1. 自测试代码的价值

​		一套测试就是一个强大的 bug 侦测器，能够大大缩减查找 bug 所需要的时间。

​		频繁进行测试是极限编程 [Beck，XP] 的重要一环。

## 4.2. JUnit 测试框架

​		我用的是 JUnit，一个由 Erich Gamma 和 Kent Beck[JUnit] 开发的开源测试框架。这个框架非常简单，却可让你进行测试所需的所有重要事情。本章中我将运用这个测试框架来为一些 IO 类开发测试代码。

### 单元测试和功能测试

​		JUnit 框架的用途是单元测试。

​		单元测试是高度局部化的东西，每个测试类都隶属于单一包。它能够测试其他包的接口，除此之外它将假设其他包一切正常。

​		功能测试就完全不同。它们用来保证软件能够正常运作。它们从客户的角度保障质量，并不关心程序员的生产力。

​		一般而言，功能测试尽可能把整个系统当作一个黑箱。面对一个拥有 GUI 的待测系统，它们通过 GUI 来操作那个系统。面对文件更新程序或数据库更新程序，功能测试只观察特定输入所导致的数据变化。

​		JUnit 框架设计用来编写单元测试。

## 4.3. 添加更多测试

​		观察类该做的所有事情，然后针对任何一项功能的任何一种可能失败情况，进行测试。这不同于某些程序员提倡的 “ 测试所有 public 函数 ”。记住，测试应该是一种风险驱动的行为，测试的目的是希望找出现在或未来可能出现的错误。所以我不会去测试那些仅仅读或写一个字段的访问函数，因为它们太简单了，不大可能出错。

​		测试的要诀是：测试你最担心出错的部分。这样你就能从测试工作中得到最大利益。

​		测试的一项重要技巧就是 “ 寻找边界条件 ”。

​		当事情被认为应该会出错时，别忘了检查是否抛出了预期的异常。

​		当测试数量达到一定程度之后，继续增加测试带来的效益就会呈现递减态势，而非持续递增；如果试图编写太多测试，你也可能因为工作量太大而气馁，最后什么都写不成。

​		不要因为测试无法捕捉所有 bug 就不写测试，因为测试的确可以捕捉到大多数 bug。

​		对象技术有个微妙处：继承和多态会让测试变得比较困难，因为将有许多种组合需要测试。如果你有 3 个彼此合作的抽象类，每个抽象类有 3 个子类，那么你总共拥有 9 个可供选择的类和 27 种组合。我并不总是试着测试所有可能组合，但我会尽量测试每一个类，这可以大大减少各种组合所造成的风险。如果这些类之间彼此有合理的独立性，我很可能不会尝试所有组合。

​		总而言之，请构筑一个良好的 bug 检测器并经常运行它，这对任何开发工作都将大有裨益，并且是重构的前提。